name: Deploy to Staging

on:
  push:
    branches:
      - stage

jobs:
  deploy:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.STAGE_SSH_KEY }}

      - name: Pull and deploy on staging server
        run: |
          ssh -o StrictHostKeyChecking=no pm2f7nn8yhci@staging.eduxoncabs.com << 'EOF'
            echo "=== Starting deployment ==="

            # Go to repo and update
            cd /home/pm2f7nn8yhci/repositories/stage_eduxoncabs || { echo "Repo missing"; exit 1; }
            git reset --hard
            git pull origin stage || { echo "Git pull failed"; exit 1; }

            # Keep .env safe
            if [ -f /home/pm2f7nn8yhci/stage_public_html/.env ]; then
              cp /home/pm2f7nn8yhci/stage_public_html/.env /tmp/.env.backup
            fi

            # Clean public folder except .env
            find /home/pm2f7nn8yhci/stage_public_html/ -mindepth 1 ! -name ".env" -exec rm -rf {} +

            # Move new html files into place
            mv /home/pm2f7nn8yhci/repositories/stage_eduxoncabs/html/* /home/pm2f7nn8yhci/stage_public_html/

            # Restore .env if it existed
            if [ -f /tmp/.env.backup ]; then
              mv /tmp/.env.backup /home/pm2f7nn8yhci/stage_public_html/.env
            fi

            # Set permissions
            chmod 600 /home/pm2f7nn8yhci/stage_public_html/.env 2>/dev/null || true
            find /home/pm2f7nn8yhci/stage_public_html/ -type f ! -name ".env" -exec chmod 644 {} \;
            find /home/pm2f7nn8yhci/stage_public_html/ -type d -exec chmod 755 {} \;

            echo "=== Deployment complete ==="
          EOF
